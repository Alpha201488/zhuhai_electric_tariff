# 💡 Home Assistant - 珠海市居民阶梯峰谷电价集成

[![GitHub Release][releases-shield]][releases]
[![License][license-shield]](LICENSE)

这是一个 Home Assistant 自定义集成，旨在为**广东省珠海市**的居民用户提供精确的实时电价计算。此集成基于珠海市最新的居民阶梯、峰谷分时电价政策（非一户一表）设计，可直接作为 Home Assistant 能源仪表板的高级价格实体。

## ✨ 特性

* **全价计算:** 自动包含电度电价、可再生能源电价附加、大水库/水利基金、居民生活用电附加等所有费用。
* **阶梯计费:** 精确判断月度用量所处的阶梯（夏季/非夏季），并应用正确的阶梯加价。
* **分时计费:** 实时根据尖峰、平段、谷段时间段，应用不同的基础电度电价。
* **HACS 支持:** 可通过 HACS 作为自定义集成安装和更新。

## ⚠️ 前提条件

1.  **HACS (Home Assistant Community Store):** 您的 Home Assistant 必须已安装 HACS。
2.  **Utility Meter:** 您必须在 Home Assistant 中配置一个 **Utility Meter** 实体，用于按**月**追踪您的总电量消耗。
    * **实体ID示例:** `sensor.monthly_kwh_usage`
    * **重要:** 请确保您的传感器 ID 与 `configuration.yaml` 或 `sensor.py` 中配置的一致。

## ⚙️ 安装步骤 (推荐 HACS)

### 1. 通过 HACS 添加自定义仓库

1.  在 Home Assistant 中打开 **HACS**。
2.  点击右上角的 **⋮** 菜单，选择 **自定义仓库 (Custom repositories)**。
3.  在弹出的对话框中，输入本仓库的 URL：`https://github.com/YourGitHubName/zhuhai_electric_tariff` **(请替换为您的实际仓库地址)**
4.  类别选择 **集成 (Integration)**。
5.  点击 **添加**。

### 2. 安装集成

1.  在 HACS 中搜索 **"Zhuhai Electricity Tariff"**。
2.  点击安装并重启 Home Assistant。

## 🔌 配置与使用

安装并重启 HA 后，集成将自动创建一个新的传感器实体。

1.  **查找新实体：**
    * 实体 ID：`sensor.zhuhai_electricity_tariff_price`
    * 此传感器会根据当前时间、月份和您 Utility Meter 的用量实时显示价格（¥/kWh）。

2.  **配置能源仪表板：**
    * 进入 **设置** -> **仪表板** -> **能源**。
    * 在 **电网消耗** 下，添加您的总电量传感器。
    * 在 **价格** 选项中，选择 **“使用来自实体的高级价格”**。
    * 选择您新创建的价格传感器：`sensor.zhuhai_electricity_tariff_price`。

## 💸 价格计算逻辑

本集成按照以下逻辑计算最终电价：

$$\text{最终电价} = \text{基础电度电价}(\text{分时}) + \text{固定成本}(\text{附加费}) + \text{阶梯加价}(\text{用量})$$

**1. 基础分时电价（电度电价部分）：**

| 季节 | 时间段 | 价格 (元/kWh) |
| :--- | :--- | :--- |
| **夏季 (6-10月)** | 尖峰 (10-12, 14-17) | 1.0203 |
| | 平段 (08-10, 12-14, 17-19) | 0.6002 |
| | 谷段 (00-08, 19-24) | 0.2281 |
| **非夏季 (11-5月)**| 高峰 (非谷段时间) | 0.6002 |
| | 低谷 (00-08, 19-24) | 0.2281 |

**2. 阶梯加价 (根据月度用量)：**

| 季节 | 梯级用量 | 阶梯加价 (元/kWh) |
| :--- | :--- | :--- |
| **夏季** | 0 - 400 kWh (梯级 1) | 0.00 |
| | 401 - 600 kWh (梯级 2) | +0.05 |
| | > 600 kWh (梯级 3) | +0.30 |
| **非夏季** | 0 - 260 kWh (梯级 1) | 0.00 |
| | 261 - 400 kWh (梯级 2) | +0.05 |
| | > 400 kWh (梯级 3) | +0.30 |

**3. 固定成本：** 0.689875 元/kWh（包含所有附加费）
